let GEMINI_API_KEY=localStorage.getItem("ai_api_key")||"AIzaSyABqrH6iKRXjJgMpaaST_ZzZfkArriOyQk";const MODEL="gemini-2.5-flash";let history=JSON.parse(localStorage.getItem("ai_history")||"[]");const css="\n      .ai-fab{position:fixed;bottom:24px;right:24px;width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;z-index:10000;cursor:pointer;transition:transform .3s ease;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);}\n      .ai-fab:hover{transform:translateY(-4px);}\n      .ai-fab:active{transform:translateY(-2px);}\n      .ai-lens-btn{position:fixed;bottom:24px;right:100px;width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);display:flex;justify-content:center;align-items:center;z-index:10000;cursor:pointer;transition:transform .3s ease;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);}\n      .ai-lens-btn:hover{transform:translateY(-4px);}\n      .ai-lens-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;cursor:crosshair;touch-action:none;}\n      .ai-lens-overlay.active{display:block;}\n      .ai-selection-box{position:absolute;border:2px dashed #667eea;background:rgba(102,126,234,.2);display:none;pointer-events:none;}\n      .ai-lens-hint{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#fff;padding:12px 24px;border-radius:8px;border:1px solid #333;font-size:14px;z-index:10000;display:none;max-width:90vw;}\n      .ai-lens-hint.active{display:block;text-align:center;}\n      .ai-modal{display:none;position:fixed;z-index:10001;top:50%;left:50%;transform:translate(-50%, -50%);}\n      .ai-modal.active{display:block;}\n      .ai-modal-content{width:90vw;max-width:540px;max-height:85vh;background:#1a1a1a;border-radius:16px;padding:0;color:#fff;border:1px solid #333;overflow:hidden;display:flex;flex-direction:column;}\n      .ai-header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:#0a0a0a;cursor:move;user-select:none;border-bottom:1px solid #333;touch-action:none;}\n      .ai-title{font-size:18px;font-weight:700;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}\n      .ai-header-actions{display:flex;gap:12px;align-items:center;}\n      .ai-icon-btn{width:24px;height:24px;cursor:pointer;opacity:.7;transition:opacity .2s;background:none;border:none;padding:0;color:#fff;}\n      .ai-icon-btn:hover{opacity:1;}\n      .ai-tabs{display:flex;background:#0a0a0a;border-bottom:1px solid #333;}\n      .ai-tab{flex:1;padding:12px;text-align:center;cursor:pointer;border:none;background:none;color:#999;font-size:14px;font-weight:600;transition:all .3s;}\n      .ai-tab.active{color:#667eea;border-bottom:2px solid #667eea;}\n      .ai-tab:hover{color:#fff;}\n      .ai-body{padding:24px;overflow-y:auto;flex:1;display:none;}\n      .ai-body.active{display:block;}\n      .ai-input{width:100%;min-height:100px;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px;background:#0a0a0a;color:#fff;resize:none;font-size:15px;font-family:inherit;transition:border-color .3s;box-sizing:border-box;}\n      .ai-input:focus{outline:none;border-color:#667eea;}\n      .ai-input::placeholder{color:#666;}\n      .ai-send-btn{width:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-weight:600;font-size:16px;border:none;padding:14px;border-radius:12px;cursor:pointer;transition:opacity .3s ease;margin-bottom:16px;}\n      .ai-send-btn:hover:not(:disabled){opacity:.9;}\n      .ai-send-btn:disabled{opacity:.5;cursor:not-allowed;}\n      .ai-skeleton{display:none;margin-top:20px;}\n      .ai-skeleton.active{display:block;}\n      .ai-skeleton-line{height:16px;background:linear-gradient(90deg,#1a1a1a 0%,#2a2a2a 50%,#1a1a1a 100%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:4px;margin-bottom:12px;}\n      .ai-skeleton-line:nth-child(1){width:95%;}\n      .ai-skeleton-line:nth-child(2){width:88%;}\n      .ai-skeleton-line:nth-child(3){width:92%;}\n      .ai-skeleton-line:nth-child(4){width:78%;}\n      .ai-skeleton-line:nth-child(5){width:85%;}\n      @keyframes skeleton-loading{0%{background-position:200% 0;}100%{background-position:-200% 0;}}\n      .ai-response{margin-top:20px;max-height:300px;overflow-y:auto;padding:20px;background:#0a0a0a;border-radius:12px;border-left:3px solid #667eea;display:none;}\n      .ai-response.active{display:block;}\n      .ai-response-title{font-weight:700;margin-bottom:12px;font-size:16px;color:#667eea;}\n      .ai-response-text{line-height:1.6;color:#e0e0e0;white-space:pre-wrap;word-wrap:break-word;}\n      .ai-captured-text{max-width:100%;border-radius:8px;margin-bottom:16px;border:1px solid #333;padding:12px;background:#0a0a0a;color:#e0e0e0;font-size:14px;white-space:pre-wrap;box-sizing:border-box;}\n      .ai-config-group{margin-bottom:20px;}\n      .ai-config-label{display:block;margin-bottom:8px;color:#999;font-size:14px;font-weight:600;}\n      .ai-config-input{width:100%;border:1px solid #333;border-radius:8px;padding:12px;background:#0a0a0a;color:#fff;font-size:14px;box-sizing:border-box;}\n      .ai-config-input:focus{outline:none;border-color:#667eea;}\n      .ai-save-btn{background:#667eea;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;transition:opacity .3s;width:100%;}\n      .ai-save-btn:hover{opacity:.9;}\n      .ai-history-item{background:#0a0a0a;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:12px;}\n      .ai-history-question{font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;}\n      .ai-history-answer{color:#e0e0e0;font-size:13px;line-height:1.5;}\n      .ai-history-date{color:#666;font-size:12px;margin-top:8px;}\n      .ai-history-empty{text-align:center;color:#666;padding:40px 20px;font-size:14px;}\n      .ai-clear-history{background:#333;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;margin-top:12px;transition:opacity .3s;width:100%;}\n      .ai-clear-history:hover{opacity:.8;}\n      .ai-response::-webkit-scrollbar,.ai-body::-webkit-scrollbar{width:8px;}\n      .ai-response::-webkit-scrollbar-track,.ai-body::-webkit-scrollbar-track{background:#1a1a1a;border-radius:4px;}\n      .ai-response::-webkit-scrollbar-thumb,.ai-body::-webkit-scrollbar-thumb{background:#333;border-radius:4px;}\n      .robot-svg{width:32px;height:32px;fill:none;stroke:#fff;stroke-width:2;}\n      .lens-svg{width:32px;height:32px;fill:none;stroke:#fff;stroke-width:2;}\n      @media (max-width: 768px) {\n        .ai-fab {\n          bottom: 20px;\n          right: 20px;\n          width: 56px;\n          height: 56px;\n        }\n        .ai-lens-btn {\n          bottom: 20px;\n          right: 80px;\n          width: 56px;\n          height: 56px;\n        }\n        .ai-lens-hint {\n          font-size: 12px;\n          padding: 8px 16px;\n          top: 10px;\n        }\n        .ai-modal-content {\n          width: 95vw;\n          max-height: 90vh;\n          border-radius: 12px;\n        }\n        .ai-header {\n          padding: 12px 16px;\n        }\n        .ai-title {\n          font-size: 16px;\n        }\n        .ai-tabs {\n          flex-direction: column;\n        }\n        .ai-tab {\n          padding: 12px 8px;\n          font-size: 14px;\n          border-bottom: 1px solid #333;\n        }\n        .ai-tab:last-child {\n          border-bottom: none;\n        }\n        .ai-body {\n          padding: 16px;\n        }\n        .ai-input {\n          min-height: 80px;\n          font-size: 14px;\n          padding: 12px;\n        }\n        .ai-send-btn {\n          font-size: 14px;\n          padding: 12px;\n        }\n        .ai-response {\n          max-height: 250px;\n          padding: 16px;\n        }\n        .ai-response-title {\n          font-size: 14px;\n        }\n        .ai-response-text {\n          font-size: 14px;\n        }\n        .ai-captured-text {\n          font-size: 13px;\n          padding: 8px;\n        }\n        .ai-config-input {\n          padding: 10px;\n          font-size: 14px;\n        }\n        .ai-save-btn {\n          padding: 10px;\n          font-size: 14px;\n        }\n        .ai-history-item {\n          padding: 12px;\n        }\n        .ai-history-question {\n          font-size: 13px;\n        }\n        .ai-history-answer {\n          font-size: 12px;\n        }\n        .ai-clear-history {\n          padding: 8px;\n          font-size: 12px;\n        }\n        .ai-skeleton-line {\n          height: 14px;\n        }\n      }\n      @media (max-width: 480px) {\n        .ai-fab, .ai-lens-btn {\n          width: 48px;\n          height: 48px;\n          bottom: 16px;\n        }\n        .ai-lens-btn {\n          right: 68px;\n        }\n        .ai-modal-content {\n          width: 98vw;\n          max-height: 95vh;\n        }\n        .ai-header {\n          padding: 10px 12px;\n        }\n        .ai-tabs {\n          padding: 0 12px;\n        }\n        .ai-body {\n          padding: 12px;\n        }\n        .ai-input {\n          min-height: 60px;\n          padding: 10px;\n        }\n        .ai-send-btn {\n          padding: 10px;\n        }\n        .ai-response {\n          padding: 12px;\n          max-height: 200px;\n        }\n        .ai-captured-text {\n          padding: 6px;\n          font-size: 12px;\n        }\n      }\n      ",style=document.createElement("style");style.textContent=css,document.head.appendChild(style);const fab=document.createElement("div");fab.className="ai-fab",fab.innerHTML='<svg class="robot-svg" viewBox="0 0 24 24"><path d="M9 12H15M9 12V15M15 12V15M9 12V9M15 12V9M12 17V19M12 7V5M7 19H17M7 5H17M7 19C7 19.5523 7.44772 20 8 20H16C16.5523 20 17 19.5523 17 19M7 5C7 4.44772 7.44772 4 8 4H16C16.5523 4 17 4.44772 17 5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',document.body.appendChild(fab);const lensBtn=document.createElement("div");lensBtn.className="ai-lens-btn",lensBtn.innerHTML='<svg class="lens-svg" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke="#fff" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="#fff" stroke-width="2" stroke-linecap="round"/><path d="M11 8v6M8 11h6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>',document.body.appendChild(lensBtn);const lensOverlay=document.createElement("div");lensOverlay.className="ai-lens-overlay",document.body.appendChild(lensOverlay);const selectionBox=document.createElement("div");selectionBox.className="ai-selection-box",lensOverlay.appendChild(selectionBox);const lensHint=document.createElement("div");lensHint.className="ai-lens-hint",lensHint.textContent="Arraste para selecionar uma área da tela • ESC para cancelar",document.body.appendChild(lensHint);const modal=document.createElement("div");modal.className="ai-modal",modal.innerHTML=`<div class="ai-modal-content">\n      <div class="ai-header">\n      <div class="ai-title">OrionAI - by NGX1305</div>\n      <div class="ai-header-actions">\n      <svg class="ai-icon-btn ai-close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <path d="M18 6L6 18M6 6l12 12"/>\n      </svg>\n      </div>\n      </div>\n      <div class="ai-tabs">\n      <button class="ai-tab active" data-tab="chat">Chat</button>\n      <button class="ai-tab" data-tab="history">Histórico</button>\n      <button class="ai-tab" data-tab="config">Configurações</button>\n      </div>\n      <div class="ai-body active" data-body="chat">\n      <textarea class="ai-input" placeholder="Digite sua pergunta aqui..."></textarea>\n      <button class="ai-send-btn">Enviar Pergunta</button>\n      <div class="ai-skeleton">\n      <div class="ai-skeleton-line"></div>\n      <div class="ai-skeleton-line"></div>\n      <div class="ai-skeleton-line"></div>\n      <div class="ai-skeleton-line"></div>\n      <div class="ai-skeleton-line"></div>\n      </div>\n      <div class="ai-response">\n      <div class="ai-response-title">💬 Resposta</div>\n      <div class="ai-response-text"></div>\n      </div>\n      </div>\n      <div class="ai-body" data-body="history">\n      <div class="ai-history-container"></div>\n      </div>\n      <div class="ai-body" data-body="config">\n      <div class="ai-config-group">\n      <label class="ai-config-label">API Key do Gemini</label>\n      <input type="text" class="ai-config-input ai-api-key-input" value="${GEMINI_API_KEY}" placeholder="Cole sua API Key aqui">\n      </div>\n      <button class="ai-save-btn">Salvar Configurações</button>\n      </div>\n      </div>`,document.body.appendChild(modal);const input=modal.querySelector(".ai-input"),sendBtn=modal.querySelector(".ai-send-btn"),skeleton=modal.querySelector(".ai-skeleton"),response=modal.querySelector(".ai-response"),responseText=modal.querySelector(".ai-response-text"),closeIcon=modal.querySelector(".ai-close-icon"),header=modal.querySelector(".ai-header"),tabs=modal.querySelectorAll(".ai-tab"),bodies=modal.querySelectorAll(".ai-body"),apiKeyInput=modal.querySelector(".ai-api-key-input"),saveBtn=modal.querySelector(".ai-save-btn"),historyContainer=modal.querySelector(".ai-history-container"),chatBody=modal.querySelector('[data-body="chat"]');let offsetX=0,offsetY=0,isDragging=!1;header.addEventListener("mousedown",(e=>{e.target.closest(".ai-icon-btn")||(isDragging=!0,offsetX=e.clientX-modal.getBoundingClientRect().left,offsetY=e.clientY-modal.getBoundingClientRect().top,header.style.cursor="grabbing")})),header.addEventListener("touchstart",(e=>{if(e.target.closest(".ai-icon-btn"))return;e.preventDefault();isDragging=!0;const t=e.touches[0];offsetX=t.clientX-modal.getBoundingClientRect().left;offsetY=t.clientY-modal.getBoundingClientRect().top;header.style.cursor="grabbing"},{passive:!1})),document.addEventListener("mousemove",(e=>{if(!isDragging)return;const t=e.clientX-offsetX,a=e.clientY-offsetY;modal.style.left=t+"px",modal.style.top=a+"px",modal.style.transform="none"})),document.addEventListener("touchmove",(e=>{if(!isDragging)return;e.preventDefault();const t=e.touches[0];const x=t.clientX-offsetX;const y=t.clientY-offsetY;modal.style.left=x+"px";modal.style.top=y+"px";modal.style.transform="none"},{passive:!1})),document.addEventListener("mouseup",(()=>{isDragging&&(isDragging=!1,header.style.cursor="move")})),document.addEventListener("touchend",(()=>{if(isDragging){isDragging=!1;header.style.cursor="move"}},{passive:!1}));let startX,startY,isSelecting=!1;async function extractTextFromArea(e,t,a,n){let i="";const o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);let s;for(;s=o.nextNode();){const o=document.createRange();o.selectNodeContents(s);const r=Array.from(o.getClientRects());for(let o of r)if(o.left<a&&o.right>e&&o.top<n&&o.bottom>t){i+=s.textContent.trim()+" ";break}}return i.trim()}function openModalWithText(e){modal.style.left="50%",modal.style.top="50%",modal.style.transform="translate(-50%, -50%)",modal.classList.add("active"),tabs.forEach((e=>e.classList.remove("active"))),bodies.forEach((e=>e.classList.remove("active"))),tabs[0].classList.add("active"),chatBody.classList.add("active");const t=chatBody.querySelector(".ai-captured-text");t&&t.remove();const a=document.createElement("div");a.textContent=e,a.className="ai-captured-text",chatBody.insertBefore(a,input),input.value=`Analise este texto: ${e}`,input.focus()}function renderHistory(){if(0===history.length)return void(historyContainer.innerHTML='<div class="ai-history-empty">Nenhum histórico ainda. Faça sua primeira pergunta!</div>');historyContainer.innerHTML=history.map((e=>`\n      <div class="ai-history-item">\n      <div class="ai-history-question">❓ ${e.question}</div>\n      <div class="ai-history-answer">${e.answer}</div>\n      <div class="ai-history-date">${new Date(e.date).toLocaleString("pt-BR")}</div>\n      </div>\n      `)).reverse().join("")+'<button class="ai-clear-history">Limpar Histórico</button>';const e=historyContainer.querySelector(".ai-clear-history");e?.addEventListener("click",(()=>{confirm("Deseja limpar todo o histórico?")&&(history=[],localStorage.setItem("ai_history",JSON.stringify(history)),renderHistory())}))}lensBtn.addEventListener("click",(()=>{lensOverlay.classList.add("active"),lensHint.classList.add("active")})),lensOverlay.addEventListener("mousedown",(e=>{isSelecting=!0,startX=e.clientX,startY=e.clientY,selectionBox.style.left=startX+"px",selectionBox.style.top=startY+"px",selectionBox.style.width="0px",selectionBox.style.height="0px",selectionBox.style.display="block"})),lensOverlay.addEventListener("touchstart",(e=>{e.preventDefault();const t=e.touches[0];isSelecting=!0,startX=t.clientX,startY=t.clientY,selectionBox.style.left=startX+"px",selectionBox.style.top=startY+"px",selectionBox.style.width="0px",selectionBox.style.height="0px",selectionBox.style.display="block"},{passive:!1})),lensOverlay.addEventListener("mousemove",(e=>{if(!isSelecting)return;const t=e.clientX,a=e.clientY,n=Math.abs(t-startX),i=Math.abs(a-startY),o=Math.min(startX,t),s=Math.min(startY,a);selectionBox.style.left=o+"px",selectionBox.style.top=s+"px",selectionBox.style.width=n+"px",selectionBox.style.height=i+"px"})),lensOverlay.addEventListener("touchmove",(e=>{e.preventDefault();if(!isSelecting)return;const t=e.touches[0];const currentX=t.clientX;const currentY=t.clientY;const width=Math.abs(currentX-startX);const height=Math.abs(currentY-startY);const left=Math.min(startX,currentX);const top=Math.min(startY,currentY);selectionBox.style.left=left+"px";selectionBox.style.top=top+"px";selectionBox.style.width=width+"px";selectionBox.style.height=height+"px"},{passive:!1})),lensOverlay.addEventListener("mouseup",(async e=>{if(!isSelecting)return;isSelecting=!1;const t=e.clientX,a=e.clientY,n=Math.abs(t-startX),i=Math.abs(a-startY);if(n<20||i<20)return lensOverlay.classList.remove("active"),lensHint.classList.remove("active"),void(selectionBox.style.display="none");const o=Math.min(startX,t),s=Math.min(startY,a),r=o+n,l=s+i;lensOverlay.classList.remove("active"),lensHint.classList.remove("active"),selectionBox.style.display="none";openModalWithText(await extractTextFromArea(o,s,r,l))})),lensOverlay.addEventListener("touchend",(async e=>{e.preventDefault();if(!isSelecting)return;isSelecting=!1;const t=e.changedTouches[0];const endX=t.clientX;const endY=t.clientY;const width=Math.abs(endX-startX);const height=Math.abs(endY-startY);if(width<20||height<20){lensOverlay.classList.remove("active");lensHint.classList.remove("active");selectionBox.style.display="none";return}const left=Math.min(startX,endX);const top=Math.min(startY,endY);const right=left+width;const bottom=top+height;lensOverlay.classList.remove("active");lensHint.classList.remove("active");selectionBox.style.display="none";const extractedText=await extractTextFromArea(left,top,right,bottom);openModalWithText(extractedText)},{passive:!1})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&lensOverlay.classList.contains("active")&&(lensOverlay.classList.remove("active"),lensHint.classList.remove("active"),selectionBox.style.display="none",isSelecting=!1)})),tabs.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tab;tabs.forEach((e=>e.classList.remove("active"))),bodies.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),modal.querySelector(`[data-body="${t}"]`).classList.add("active"),"history"===t&&renderHistory()}))})),saveBtn.addEventListener("click",(()=>{const e=apiKeyInput.value.trim();e?(GEMINI_API_KEY=e,localStorage.setItem("ai_api_key",e),alert("Configurações salvas com sucesso!")):alert("Por favor, insira uma API Key válida.")})),fab.addEventListener("click",(()=>{modal.classList.contains("active")||(modal.style.left="50%",modal.style.top="50%",modal.style.transform="translate(-50%, -50%)"),modal.classList.add("active"),input.focus()})),closeIcon.addEventListener("click",(()=>{modal.classList.remove("active")})),sendBtn.addEventListener("click",(async()=>{const e=input.value.trim();if(e){sendBtn.disabled=!0,sendBtn.textContent="Carregando...",skeleton.classList.add("active"),response.classList.remove("active");try{const t=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}`,a={contents:[{parts:[{text:`responda essa pergunta limitando-se a 200 palavras: ${e}`}]}]},n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw new Error(`HTTP ${n.status}`);const i=(await n.json()).candidates[0].content.parts[0].text;responseText.textContent=i,response.classList.add("active"),history.push({question:e,answer:i,date:(new Date).toISOString()}),localStorage.setItem("ai_history",JSON.stringify(history)),input.value="";const o=chatBody.querySelector(".ai-captured-text");o&&o.remove()}catch(e){alert(`Erro ao processar sua pergunta: ${e.message}`)}finally{sendBtn.disabled=!1,sendBtn.textContent="Enviar Pergunta",skeleton.classList.remove("active")}}else alert("Por favor, digite sua pergunta.")})),input.addEventListener("keydown",(e=>{e.ctrlKey&&"Enter"===e.key&&sendBtn.click()}));
